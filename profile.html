<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500&display=swap" rel="stylesheet">
    <title>الملف الشخصي</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
    :root {
        --primary: #D1AD59;
        --secondary: #1B1A17;
        --text: #fff;
        --muted: #adb5bd;
        --background: #121212;
        --card-bg: #121212;
        --success: #01B276;
        --error: #FE2B54;
        --hover: #D1AD59;
        --border: #ced4da;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Rubik', sans-serif;
    }

    body {
        background: var(--background);
        color: var(--text);
        padding: 20px;
        user-select: none;
    }

    .container {
        max-width: 600px;
        margin: 0 auto;
    }

    .profile-header {
        background: var(--card-bg);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        border: 1px solid var(--border);
        text-align: center;
    }

    .profile-avatar {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        object-fit: cover;
        margin-bottom: 15px;
        transition: transform 0.3s ease;
    }

    .profile-avatar:hover {
        transform: scale(1.05);
    }

    .profile-name {
        font-size: 1.2em;
        font-weight: bold;
        margin-bottom: 10px;
    }

    .edit-btn {
        background: var(--primary);
        color: white;
        padding: 10px 20px;
        border-radius: 12px;
        border: none;
        transition: background 0.3s, transform 0.3s;
        font-size: 1em;
    }

    .edit-btn:hover {
        background: var(--hover);
        transform: translateY(-2px);
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .modal-content {
        background: var(--card-bg);
        border-radius: 15px;
        padding: 20px;
        max-width: 500px;
        width: 90%;
        border: 1px solid var(--border);
        text-align: center;
        position: relative;
    }

    .close-btn {
        position: absolute;
        top: 10px;
        left: 15px;
        background: none;
        border: none;
        font-size: 1.5em;
        color: var(--muted);
    }

    .modal-content .avatar-preview {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        object-fit: cover;
        margin-bottom: 15px;
        border: 2px dashed var(--primary);
    }

    .modal-content input {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        background: var(--secondary);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text);
        font-size: 1em;
        transition: border-color 0.3s ease;
    }

    .modal-content input:focus {
        outline: none;
        border-color: var(--primary);
    }

    .modal-content label {
        display: block;
        text-align: right;
        color: var(--muted);
        font-size: 0.9em;
        margin-bottom: 5px;
    }

    .save-btn {
        background: var(--primary);
        color: white;
        padding: 8px 16px;
        border-radius: 12px;
        border: none;
        transition: background 0.3s, transform 0.3s;
        font-size: 0.9em;
        margin-top: 5px;
    }

    .save-btn:hover {
        background: var(--hover);
        transform: translateY(-2px);
    }

    .save-btn.loading::after {
        content: '';
        position: absolute;
        width: 16px;
        height: 16px;
        border: 2px solid #fff;
        border-top: 2px solid transparent;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
    }

    @keyframes spin {
        0% { transform: translateY(-50%) rotate(0deg); }
        100% { transform: translateY(-50%) rotate(360deg); }
    }

    .edit-avatar-btn {
        background: none;
        border: none;
        color: var(--primary);
        font-size: 1.2em;
        transition: transform 0.3s;
        margin-bottom: 15px;
    }

    .edit-avatar-btn:hover {
        transform: scale(1.1);
    }

    .tabs {
        display: flex;
        justify-content: center;
        background: var(--card-bg);
        border-radius: 15px;
        padding: 5px;
        margin-bottom: 20px;
        border: 1px solid var(--border);
    }

    .tab-btn {
        color: var(--muted);
        font-size: 1.0em;
        padding: 10px 15px;
        transition: color 0.3s, background 0.3s;
    }

    .tab-btn.active {
        color: var(--primary);
        background: rgba(209, 173, 89, 0.1);
        border-radius: 10px;
    }

    .tab-btn:hover {
        color: var(--primary);
    }

    .tab-content {
        display: none;
        background: var(--card-bg);
        border-radius: 15px;
        padding: 15px;
        border: 1px solid var(--border);
    }

    .tab-content.active {
        display: block;
    }

    .listing {
        background: var(--card-bg);
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 25px;
        border: 1px solid var(--border);
        transition: transform 0.3s ease;
        position: relative;
    }

    .listing:hover {
        transform: translateY(-2px);
    }

    .listing-content {
        margin-bottom: 15px;
        line-height: 1.6;
        word-wrap: break-word;
        overflow-wrap: anywhere;
    }

    .listing-address {
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--border);
    }

    .listing-description {
        margin-top: 10px;
    }

    .listing-media {
        display: flex;
        gap: 10px;
        margin-top: 10px;
    }

    .listing-image {
        width: 50%;
        border-radius: 15px;
        object-fit: cover;
        max-height: 200px;
    }

    .listing-actions {
        display: flex;
        justify-content: flex-end;
        margin-top: 15px;
        padding-top: 10px;
        border-top: 1px solid var(--border);
    }

    .action-btn {
        color: var(--muted);
        display: flex;
        align-items: center;
        gap: 8px;
        border: none;
        padding: 8px 15px;
        border-radius: 15px;
        background: none;
        transition: 0.3s;
    }

    .action-btn:hover {
        background: rgba(209, 173, 89, 0.1);
        color: var(--primary);
    }

    .delete-btn {
        color: var(--error);
    }

    .delete-btn:hover {
        color: #c82333;
        background: rgba(254, 43, 84, 0.1);
    }

    .listing-time {
        color: var(--muted);
        font-size: 0.9em;
        margin-top: 10px;
        display: block;
    }

    .no-items {
        text-align: center;
        color: var(--muted);
        font-size: 1.1em;
        padding: 20px;
    }

    .verified-icon {
        width: 17px;
        height: 17px;
        margin-top: -5px;
        vertical-align: middle;
    }

    .custom-alert {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--card-bg);
        padding: 20px;
        border-radius: 12px;
        z-index: 2000;
        max-width: 400px;
        width: 90%;
        text-align: center;
        opacity: 0;
        transition: opacity 0.3s ease, transform 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .custom-alert.show {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }

    .custom-alert.success {
        border-left: 4px solid var(--success);
    }

    .custom-alert.error {
        border-left: 4px solid var(--error);
    }

    .custom-alert p {
        margin: 0 0 15px;
        font-size: 1em;
        color: var(--text);
    }

    .custom-alert button {
        background: var(--primary);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 8px;
        transition: background 0.3s, transform 0.3s;
    }

    .custom-alert button:hover {
        background: var(--hover);
        transform: translateY(-2px);
    }

    .comments-section {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid var(--border);
    }

    .comment-entry {
        background: var(--secondary);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 10px;
        position: relative;
        transition: transform 0.3s ease;
    }

    .comment-entry:hover {
        transform: translateY(-2px);
    }

    .comment-text {
        margin-bottom: 10px;
        line-height: 1.6;
        word-wrap: break-word;
        overflow-wrap: anywhere;
    }

    .comment-user {
        font-size: 0.9em;
        color: var(--primary);
        margin-bottom: 5px;
    }

    .comment-time {
        color: var(--muted);
        font-size: 0.9em;
        margin-top: 5px;
        display: block;
    }

    .comment-actions {
        display: flex;
        justify-content: flex-end;
    }
    </style>
    <script src="https://www.gstatic.com/firebasejs/8.3.3/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.3.3/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.3.3/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.3.3/firebase-storage.js"></script>
</head>
<body>
    <div class="container">
        <div class="profile-header" id="profileHeader">
            <img id="profileAvatar" src="https://via.placeholder.com/100" class="profile-avatar">
            <input type="file" id="avatarInput" accept="image/*" style="display: none;" onchange="storeAvatar(event)">
            <div class="profile-name" id="profileName">مستخدم</div>
            <button class="edit-btn" onclick="toggleEditForm()">تعديل الملف الشخصي</button>
        </div>

        <div class="modal" id="editModal">
            <div class="modal-content">
                <button class="close-btn" onclick="toggleEditForm()">×</button>
                <img id="avatarPreview" src="https://via.placeholder.com/100" class="avatar-preview">
                <label for="avatarInput">الصورة الشخصية (حد أقصى 2 ميجابايت)</label>
                <button class="edit-avatar-btn" onclick="document.getElementById('avatarInput').click()">
                    <i class="fas fa-camera"></i> تعديل الصورة
                </button>
                <button class="save-btn" onclick="saveAvatar()">حفظ الصورة</button>
                <label for="editName">الاسم (حد أقصى 30 حرفًا)</label>
                <input type="text" id="editName" placeholder="أدخل اسمك" maxlength="30">
                <button class="save-btn" onclick="saveName()">حفظ الاسم</button>
            </div>
        </div>

        <div class="tabs">
            <div class="tab-btn active" onclick="showTab('listings')">الإعلانات</div>
        </div>

        <div id="listings" class="tab-content active"></div>
    </div>

    <script>
        // Define showCustomAlert first
        function showCustomAlert(message, type = 'success') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `custom-alert ${type}`;
            alertDiv.innerHTML = `
                <p>${message}</p>
                <button onclick="this.parentElement.remove()">حسنًا</button>
            `;
            document.body.appendChild(alertDiv);
            setTimeout(() => alertDiv.classList.add('show'), 10);
            setTimeout(() => alertDiv.remove(), 5000);
        }

        // Firebase configuration and initialization
        const firebaseConfig = {
            apiKey: "AIzaSyC4aW-Mr469PsIYT8n3jL--GbtRU5OTWdo",
            authDomain: "smart-pay-6a9b8.firebaseapp.com",
            projectId: "smart-pay-6a9b8",
            storageBucket: "smart-pay-6a9b8.appspot.com",
            messagingSenderId: "9418007073",
            appId: "1:9418007073:web:72e0144eb56524fc263960"
        };

        try {
            firebase.initializeApp(firebaseConfig);
            console.log("Firebase تم تهيئته بنجاح");
        } catch (error) {
            console.error("خطأ في تهيئة Firebase:", error);
            showCustomAlert("حدث خطأ أثناء تهيئة التطبيق: " + error.message, 'error');
        }

        const db = firebase.firestore();
        const storage = firebase.storage();
        let currentUserData = {};
        let userListings = [];
        let newAvatarUrl = null;

        firebase.auth().onAuthStateChanged(async (user) => {
            if (user) {
                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    currentUserData = userDoc.exists ? userDoc.data() : {};
                    loadProfile(user.uid);
                    loadUserListings(user.uid);
                } catch (error) {
                    console.error("خطأ في جلب بيانات المستخدم:", error);
                    showCustomAlert('خطأ في جلب بيانات المستخدم: ' + error.message, 'error');
                }
            } else {
                window.location.href = 'index.html';
            }
        });

        function loadProfile(userId) {
            const profileAvatar = document.getElementById('profileAvatar');
            const profileName = document.getElementById('profileName');

            profileAvatar.src = currentUserData.avatar || 'https://via.placeholder.com/100';
            profileName.textContent = currentUserData.name || 'مستخدم';
            if (currentUserData.verified) {
                profileName.innerHTML += ` <img src="https://up6.cc/2025/01/173772594545191.png" class="verified-icon" alt="موثق">`;
            }
        }

        function toggleEditForm() {
            const editModal = document.getElementById('editModal');
            const editName = document.getElementById('editName');
            const avatarPreview = document.getElementById('avatarPreview');
            
            if (editModal.style.display === 'flex') {
                editModal.style.display = 'none';
            } else {
                editModal.style.display = 'flex';
                editName.value = currentUserData.name || '';
                avatarPreview.src = currentUserData.avatar || 'https://via.placeholder.com/100';
                newAvatarUrl = null;
            }
        }

        function storeAvatar(event) {
            const file = event.target.files[0];
            if (!file) return;

            const fileSizeMB = file.size / (1024 * 1024);
            if (fileSizeMB > 2) {
                showCustomAlert('حجم الصورة يتجاوز الحد الأقصى (2 ميجابايت)', 'error');
                event.target.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function() {
                newAvatarUrl = reader.result;
                document.getElementById('avatarPreview').src = newAvatarUrl;
                showCustomAlert('تم اختيار الصورة بنجاح!', 'success');
            };
            reader.readAsDataURL(file);
        }

        function formatTimeRemaining(ms) {
            const days = Math.floor(ms / (1000 * 60 * 60 * 24));
            const hours = Math.floor((ms % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
            let result = '';
            if (days > 0) result += `${days} يوم `;
            if (hours > 0) result += `${hours} ساعة `;
            if (minutes > 0 && days === 0) result += `${minutes} دقيقة `;
            return result.trim() || 'أقل من دقيقة';
        }

        async function updateUserInfoInListings(userId, updates) {
            try {
                const listingsSnapshot = await db.collection('listings').where('userId', '==', userId).get();
                if (listingsSnapshot.empty) return;

                const batch = db.batch();
                listingsSnapshot.forEach(doc => {
                    batch.update(doc.ref, updates);
                });

                await batch.commit();
            } catch (error) {
                console.error("خطأ في تحديث بيانات المستخدم في الإعلانات:", error);
                showCustomAlert('خطأ في تحديث بيانات المستخدم في الإعلانات: ' + error.message, 'error');
            }
        }

        async function updateUserInfoInComments(userId, updates) {
            try {
                const listingsSnapshot = await db.collection('listings').get();
                if (listingsSnapshot.empty) return;

                const batch = db.batch();
                listingsSnapshot.forEach(doc => {
                    const listing = doc.data();
                    if (listing.comments) {
                        const commentUpdates = {};
                        Object.entries(listing.comments).forEach(([commentId, comment]) => {
                            if (comment.userId === userId) {
                                if (updates.name) commentUpdates[`comments.${commentId}.userName`] = updates.name;
                                if (updates.avatar) commentUpdates[`comments.${commentId}.avatar`] = updates.avatar;
                            }
                        });
                        if (Object.keys(commentUpdates).length > 0) {
                            batch.update(doc.ref, commentUpdates);
                        }
                    }
                });

                await batch.commit();
            } catch (error) {
                console.error("خطأ في تحديث بيانات المستخدم في التعليقات:", error);
                showCustomAlert('خطأ في تحديث بيانات المستخدم في التعليقات: ' + error.message, 'error');
            }
        }

        async function saveAvatar() {
            const user = firebase.auth().currentUser;
            if (!user) return;

            const saveBtn = document.querySelector('.save-btn[onclick="saveAvatar()"]');
            if (!newAvatarUrl) {
                showCustomAlert('لم يتم اختيار صورة جديدة', 'error');
                return;
            }

            saveBtn.classList.add('loading');
            saveBtn.disabled = true;

            try {
                const now = firebase.firestore.Timestamp.now();
                const nowMs = now.toMillis();
                const lastAvatarChange = currentUserData.lastAvatarChange || { toMillis: () => 0 };
                const timeSinceLastAvatarChange = nowMs - lastAvatarChange.toMillis();
                const avatarCooldown = 3 * 24 * 60 * 60 * 1000; // 3 أيام

                if (timeSinceLastAvatarChange < avatarCooldown) {
                    const timeRemaining = avatarCooldown - timeSinceLastAvatarChange;
                    showCustomAlert(`يمكنك تغيير الصورة بعد ${formatTimeRemaining(timeRemaining)}`, 'error');
                    return;
                }

                const file = document.getElementById('avatarInput').files[0];
                const storageRef = storage.ref();
                const oldAvatarUrl = currentUserData.avatar;

                if (oldAvatarUrl && !oldAvatarUrl.includes('via.placeholder.com')) {
                    await storage.refFromURL(oldAvatarUrl).delete().catch(error => {
                        console.error(`خطأ في حذف الصورة القديمة:`, error);
                    });
                }

                const newAvatarRef = storageRef.child(`avatars/${user.uid}/${Date.now()}_${file.name}`);
                await newAvatarRef.put(file);
                const uploadedAvatarUrl = await newAvatarRef.getDownloadURL();

                await db.collection('users').doc(user.uid).update({
                    avatar: uploadedAvatarUrl,
                    lastAvatarChange: now
                });

                await updateUserInfoInListings(user.uid, { avatar: uploadedAvatarUrl });
                await updateUserInfoInComments(user.uid, { avatar: uploadedAvatarUrl });

                currentUserData.avatar = uploadedAvatarUrl;
                currentUserData.lastAvatarChange = now;
                loadProfile(user.uid);
                showCustomAlert('تم حفظ الصورة بنجاح!', 'success');
                toggleEditForm();
            } catch (error) {
                console.error("خطأ في حفظ الصورة:", error);
                showCustomAlert('خطأ في حفظ الصورة: ' + error.message, 'error');
            } finally {
                saveBtn.classList.remove('loading');
                saveBtn.disabled = false;
            }
        }

        async function saveName() {
            const user = firebase.auth().currentUser;
            if (!user) return;

            const newName = document.getElementById('editName').value.trim();
            const saveBtn = document.querySelector('.save-btn[onclick="saveName()"]');

            if (!newName) {
                showCustomAlert('الاسم لا يمكن أن يكون فارغًا', 'error');
                return;
            }
            if (newName.length > 30) {
                showCustomAlert('الاسم يجب ألا يتجاوز 30 حرفًا', 'error');
                return;
            }
            if (newName === currentUserData.name) {
                showCustomAlert('لم يتم تغيير الاسم', 'error');
                return;
            }

            saveBtn.classList.add('loading');
            saveBtn.disabled = true;

            try {
                const now = firebase.firestore.Timestamp.now();
                const nowMs = now.toMillis();
                const lastNameChange = currentUserData.lastNameChange || { toMillis: () => 0 };
                const timeSinceLastNameChange = nowMs - lastNameChange.toMillis();
                const nameCooldown = 7 * 24 * 60 * 60 * 1000; // 7 أيام

                if (timeSinceLastNameChange < nameCooldown) {
                    const timeRemaining = nameCooldown - timeSinceLastNameChange;
                    showCustomAlert(`يمكنك تغيير الاسم بعد ${formatTimeRemaining(timeRemaining)}`, 'error');
                    return;
                }

                await db.collection('users').doc(user.uid).update({
                    name: newName,
                    lastNameChange: now
                });

                await updateUserInfoInListings(user.uid, { name: newName });
                await updateUserInfoInComments(user.uid, { name: newName });

                currentUserData.name = newName;
                currentUserData.lastNameChange = now;
                loadProfile(user.uid);
                showCustomAlert('تم حفظ الاسم بنجاح!', 'success');
                toggleEditForm();
            } catch (error) {
                console.error("خطأ في حفظ الاسم:", error);
                showCustomAlert('خطأ في حفظ الاسم: ' + error.message, 'error');
            } finally {
                saveBtn.classList.remove('loading');
                saveBtn.disabled = false;
            }
        }

        function loadUserListings(userId) {
            db.collection('listings').where('userId', '==', userId).get()
                .then((snapshot) => {
                    userListings = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderUserListings(userId);
                })
                .catch((error) => {
                    console.error("خطأ في جلب الإعلانات:", error);
                    showCustomAlert('خطأ في جلب الإعلانات: ' + error.message, 'error');
                });
        }

        function renderUserListings(userId) {
            const listingsList = document.getElementById('listings');
            listingsList.innerHTML = userListings.length > 0 
                ? userListings.map(listing => {
                    const addressParts = [listing.city];
                    if (listing.neighborhood) addressParts.push(listing.neighborhood);
                    if (listing.manualAddress) addressParts.push(listing.manualAddress);
                    const fullAddress = addressParts.join(', ');
                    let mediaHtml = listing.images && listing.images.length > 0 
                        ? `<div class="listing-media">${listing.images.map(image => `<img src="${image}" class="listing-image" alt="صورة العقار">`).join('')}</div>`
                        : '';
                    let commentsHtml = '';
                    if (listing.comments) {
                        commentsHtml = Object.entries(listing.comments).map(([commentId, comment]) => `
                            <div class="comment-entry">
                                <div class="comment-user">${comment.userName}</div>
                                <div class="comment-text">${formatText(comment.text)}</div>
                                ${comment.userId === userId ? `
                                    <div class="comment-actions">
                                        <div class="action-btn delete-btn" onclick="deleteComment('${listing.id}', '${commentId}')">
                                            <i class="fas fa-trash"></i> حذف
                                        </div>
                                    </div>
                                ` : ''}
                                <span class="comment-time">${timeAgo(comment.time instanceof firebase.firestore.Timestamp ? comment.time.toMillis() : comment.time)}</span>
                            </div>
                        `).join('');
                    }
                    return `
                        <div class="listing">
                            <div class="listing-content">
                                <div class="listing-address">
                                    <strong>النوع:</strong> ${listing.type === 'rent' ? 'للإيجار' : 'للبيع'}<br>
                                    <strong>السعر:</strong> ${listing.price} ${listing.currency}<br>
                                    <strong>العنوان:</strong> ${fullAddress}
                                </div>
                                <div class="listing-description">
                                    <p>${listing.description || ''}</p>
                                </div>
                            </div>
                            ${mediaHtml}
                            <div class="listing-actions">
                                <div class="action-btn delete-btn" onclick="deleteListing('${listing.id}')">
                                    <i class="fas fa-trash"></i> حذف
                                </div>
                            </div>
                            <span class="listing-time">${timeAgo(listing.time instanceof firebase.firestore.Timestamp ? listing.time.toMillis() : listing.time)}</span>
                            ${commentsHtml ? `<div class="comments-section">${commentsHtml}</div>` : ''}
                        </div>`;
                }).join('')
                : '<div class="no-items">لا توجد إعلانات بعد</div>';
        }

        async function deleteListing(listingId) {
            const listingRef = db.collection('listings').doc(listingId);
            try {
                const listingDoc = await listingRef.get();
                if (listingDoc.exists && listingDoc.data().images) {
                    for (const image of listingDoc.data().images) {
                        await storage.refFromURL(image).delete().catch(error => {
                            console.error(`خطأ في حذف الصورة ${image}:`, error);
                        });
                    }
                }

                await listingRef.delete();
                console.log("تم حذف الإعلان بنجاح:", listingId);
                showCustomAlert('تم حذف الإعلان بنجاح!', 'success');
                loadUserListings(firebase.auth().currentUser.uid);
            } catch (error) {
                console.error("خطأ في حذف الإعلان:", error);
                showCustomAlert('خطأ في حذف الإعلان: ' + error.message, 'error');
            }
        }

        async function deleteComment(listingId, commentId) {
            const listingRef = db.collection('listings').doc(listingId);
            try {
                await listingRef.update({
                    [`comments.${commentId}`]: firebase.firestore.FieldValue.delete()
                });
                console.log("تم حذف التعليق بنجاح:", commentId);
                showCustomAlert('تم حذف التعليق بنجاح!', 'success');
                loadUserListings(firebase.auth().currentUser.uid);
            } catch (error) {
                console.error("خطأ في حذف التعليق:", error);
                showCustomAlert('خطأ في حذف التعليق: ' + error.message, 'error');
            }
        }

        function formatText(text) {
            return text
                .replace(/#(\w+)/g, '<span style="color: var(--primary);">#$1</span>')
                .replace(/@(\w+)/g, '<span style="color: var(--primary);">@$1</span>');
        }

        function timeAgo(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 60) return `منذ ${minutes} دقيقة`;
            if (hours < 24) return `منذ ${hours} ساعة`;
            return `منذ ${days} يوم`;
        }

        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(tabId).classList.add('active');
            document.querySelector(`.tab-btn[onclick="showTab('${tabId}')"]`).classList.add('active');
        }
    </script>
</body>
</html>
